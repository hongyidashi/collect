# WebSocket 知识点

目录
+ [WebSocket简介](#WebSocket简介)
+ [WebSocket特点](#WebSocket特点)
+ [为什么需要WebSocket](#为什么需要WebSocket)


## WebSocket简介
WebSocket 是一种基于 TCP 的网络协议，也是一种全双工通信的协议，既允许客户端向服务器主动发送消息，也允许服务器主动向客户端发送消息。在 WebSocket 中，浏览器和服务器只需要**完成**(不是只进行一次)一次握手，两者之间就可以建立持久性的连接，进行双向数据传输。

## WebSocket特点
1. 连接握手阶段使用 HTTP 协议；
2. 协议标识符是 ws，如果采用加密则是 wss；
3. 数据格式比较轻量，性能开销小，通信高效；
4. 没有同源限制，客户端可以与任意服务器通信；
5. 建立在 TCP 协议之上，服务器端的实现比较容易；
6. 通过 WebSocket 可以发送文本，也可以发送二进制数据；
7. 与 HTTP 协议有着良好的兼容性。默认端口也是 80 和 443，并且握手阶段采用 HTTP 协议，因此握手时不容易屏蔽，能通过各种 HTTP 代理服务器。


> **同源限制**  
> 早就猜到你个憨批可能会不知道啥是同源策略，爷特地找了个  
> 同源策略限制从一个源（协议、域名、端口）加载的文档或脚本如何与来自另一个源的资源进行交互；这是一个用于隔离潜在的恶意文件的关键的安全机制；如果源不一样就是协议、域名、端口有一个不一样的话，就是非同源策略，就跨域了。  
> 什么是限制呢？就是说不是一个源的文档，你没有权力去操作另一个源的文档，主要限制的几个方面如下：
> 1. Cookie 、LocalStorage 和 IndexDB无法读取；
> 2. 无法获取或操作另一个资源的DOM；
> 3. AJAX请求不能发送。

## 为什么需要WebSocket
在没有 WebSocket 时，基于 Web 的消息基本上是靠 Http 协议进行通信，而经常有”聊天室”、”消息推送”、”股票信息实时动态”等这样需求，而实现这样的需求常用的有以下几种解决方案：  
![方案](images/为什么需要ws.png)

1. 短轮询(Traditional Polling)  
短轮询是指客户端每隔一段时间就询问一次服务器是否有新的消息，如果有就接收消息；这样方式会增加很多次无意义的发送请求信息，每次都会耗费流量及处理器资源。
- 优点：短连接，服务器处理简单，支持跨域、浏览器兼容性较好；
- 缺点：有一定延迟、服务器压力较大，浪费带宽流量、大部分是无效请求。

2. 长轮询(Long Polling)  
长轮询是段轮询的改进，客户端执行 HTTP 请求发送消息到服务器后，等待服务器回应，如果没有新消息就一直等待，直到服务器有新消息传回或者超时。  
这也是个反复的过程，这种做法只是减小了网络带宽和处理器的消耗，但是带来的问题是导致消息实时性低，延迟严重，而且也是基于循环，最根本的带宽及处理器资源占用并没有得到有效的解决。
- 优点：减少轮询次数，低延迟，浏览器兼容性较好；
- 缺点：服务器需要保持大量连接。

3. 服务器发送事件(Server-Sent Event)  
服务器发送事件是一种服务器向浏览器客户端发起数据传输的技术。一旦创建了初始连接，事件流将保持打开状态，直到客户端关闭。该技术通过传统的 HTTP 发送，并具有 WebSockets 缺乏的各种功能，例如”自动重新连接”、”事件ID” 及 “发送任意事件”的能力。  
服务器发送事件是单向通道，只能服务器向浏览器发送，因为流信息本质上就是下载。
- 优点：适用于更新频繁、低延迟并且数据都是从服务端发到客户端；
- 缺点：浏览器兼容难度高(目前除了 IE/Edge，其他浏览器都支持)。

上面这几种方式都有各自的优缺点，虽然靠轮询方式能够实现这些一些功能，但是其对性能的开销和低效率是非常致命的，尤其是在移动端流行的现在。

现在客户端与服务端双向通信的需求越来越多，且现在的浏览器大部分都支持 WebSocket。所以对实时性和双向通信及其效率有要求的话，比较推荐使用 WebSocket。
