# Spring Security çŸ¥è¯†ç‚¹

ç›®å½•
+ [SpringSecurity+JWT](#SpringSecurity+JWT)
  + [SpringSecurityçš„å·¥ä½œæµç¨‹](#SpringSecurityçš„å·¥ä½œæµç¨‹)
  + [SpringSecurityçš„é‡è¦æ¦‚å¿µ](#SpringSecurityçš„é‡è¦æ¦‚å¿µ)
  + [ç¼–ç å‰çš„å‡†å¤‡å·¥ä½œ](#ç¼–ç å‰çš„å‡†å¤‡å·¥ä½œ)
  + [ä»£ç ä¸­çš„å…·ä½“å®ç°](#ä»£ç ä¸­çš„å…·ä½“å®ç°)
+ [SpringSecurityåŠ¨æ€é‰´æƒ](#SpringSecurityåŠ¨æ€é‰´æƒ)
  + [SpringSecurityçš„é‰´æƒåŸç†](#SpringSecurityçš„é‰´æƒåŸç†)
  + [åŠ¨æ€é‰´æƒå®ç°](#åŠ¨æ€é‰´æƒå®ç°)

## SpringSecurity+JWT
### SpringSecurityçš„å·¥ä½œæµç¨‹
**Spring Security çš„webåŸºç¡€æ˜¯Filtersï¼šå³é€šè¿‡ä¸€å±‚å±‚çš„Filtersæ¥å¯¹webè¯·æ±‚åšå¤„ç†**ã€‚

ä¸€ä¸ªwebè¯·æ±‚ä¼šç»è¿‡ä¸€æ¡è¿‡æ»¤å™¨é“¾ï¼Œåœ¨ç»è¿‡è¿‡æ»¤å™¨é“¾çš„è¿‡ç¨‹ä¸­ä¼šå®Œæˆè®¤è¯ä¸æˆæƒï¼Œå¦‚æœä¸­é—´å‘ç°è¿™æ¡è¯·æ±‚æœªè®¤è¯æˆ–è€…æœªæˆæƒï¼Œä¼šæ ¹æ®è¢«ä¿æŠ¤APIçš„æƒé™å»æŠ›å‡ºå¼‚å¸¸ï¼Œç„¶åç”±å¼‚å¸¸å¤„ç†å™¨å»å¤„ç†è¿™äº›å¼‚å¸¸ã€‚

![png](images/securityåŸºæœ¬åŸç†å›¾.jpeg)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸€ä¸ªè¯·æ±‚æƒ³è¦è®¿é—®åˆ°APIå°±ä¼šä»¥ä»å·¦åˆ°å³çš„å½¢å¼ç»è¿‡è“çº¿æ¡†æ¡†é‡Œé¢çš„è¿‡æ»¤å™¨ï¼Œå…¶ä¸­ç»¿è‰²éƒ¨åˆ†æ˜¯è´Ÿè´£è®¤è¯çš„è¿‡æ»¤å™¨ï¼Œè“è‰²éƒ¨åˆ†è´Ÿè´£å¼‚å¸¸å¤„ç†ï¼Œæ©™è‰²éƒ¨åˆ†åˆ™æ˜¯è´Ÿè´£æˆæƒã€‚

å›¾ä¸­çš„è¿™ä¸¤ä¸ªç»¿è‰²è¿‡æ»¤å™¨ä¸ä¼šå»è¯´ï¼Œå› ä¸ºè¿™æ˜¯Spring Securityå¯¹formè¡¨å•è®¤è¯å’ŒBasicè®¤è¯å†…ç½®çš„ä¸¤ä¸ªFilterï¼Œè€Œæˆ‘ä»¬çš„demoæ˜¯JWTè®¤è¯æ–¹å¼æ‰€ä»¥ç”¨ä¸ä¸Šã€‚

å› ä¸ºSpring Securityè‡ªå¸¦çš„è¿‡æ»¤å™¨ä¸­æ˜¯æ²¡æœ‰é’ˆå¯¹JWTè¿™ç§è®¤è¯æ–¹å¼çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„demoä¸­ä¼šå†™ä¸€ä¸ªJWTçš„è®¤è¯è¿‡æ»¤å™¨ï¼Œç„¶åæ”¾åœ¨ç»¿è‰²çš„ä½ç½®è¿›è¡Œè®¤è¯å·¥ä½œã€‚

### SpringSecurityçš„é‡è¦æ¦‚å¿µ
çŸ¥é“äº†Spring Securityçš„å¤§è‡´å·¥ä½œæµç¨‹ä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦çŸ¥é“ä¸€äº›éå¸¸é‡è¦çš„æ¦‚å¿µä¹Ÿå¯ä»¥è¯´æ˜¯ç»„ä»¶ï¼š
- **SecurityContext**ï¼šä¸Šä¸‹æ–‡å¯¹è±¡ï¼ŒAuthenticationå¯¹è±¡ä¼šæ”¾åœ¨é‡Œé¢ï¼›
- **SecurityContextHolder**ï¼šç”¨äºæ‹¿åˆ°ä¸Šä¸‹æ–‡å¯¹è±¡çš„é™æ€å·¥å…·ç±»ï¼›
- **Authentication**ï¼šè®¤è¯æ¥å£ï¼Œå®šä¹‰äº†è®¤è¯å¯¹è±¡çš„æ•°æ®å½¢å¼ï¼›
- **AuthenticationManager**ï¼šç”¨äºæ ¡éªŒAuthenticationï¼Œè¿”å›ä¸€ä¸ªè®¤è¯å®Œæˆåçš„Authenticationå¯¹è±¡ã€‚

#### SecurityContext
ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œè®¤è¯åçš„æ•°æ®å°±æ”¾åœ¨è¿™é‡Œé¢ï¼Œæ¥å£å®šä¹‰å¦‚ä¸‹ï¼š
```java
public interface SecurityContext extends Serializable {
 // è·å–Authenticationå¯¹è±¡
 Authentication getAuthentication();

 // æ”¾å…¥Authenticationå¯¹è±¡
 void setAuthentication(Authentication authentication);
}
```
è¿™ä¸ªæ¥å£é‡Œé¢åªæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œå…¶ä¸»è¦ä½œç”¨å°±æ˜¯get or set Authenticationã€‚

#### SecurityContextHolder
```java
public class SecurityContextHolder {

 public static void clearContext() {
  strategy.clearContext();
 }

 public static SecurityContext getContext() {
  return strategy.getContext();
 }
    
    public static void setContext(SecurityContext context) {
  strategy.setContext(context);
 }
}
```
å¯ä»¥è¯´æ˜¯SecurityContextçš„å·¥å…·ç±»ï¼Œç”¨äºget or set or clear SecurityContextï¼Œé»˜è®¤ä¼šæŠŠæ•°æ®éƒ½å­˜å‚¨åˆ°å½“å‰çº¿ç¨‹ä¸­ã€‚

#### Authentication
```java
public interface Authentication extends Principal, Serializable {
 
 Collection<? extends GrantedAuthority> getAuthorities();
 Object getCredentials();
 Object getDetails();
 Object getPrincipal();
 boolean isAuthenticated();
 void setAuthenticated(boolean isAuthenticated) throws IllegalArgumentException;
}
```
è¿™å‡ ä¸ªæ–¹æ³•æ•ˆæœå¦‚ä¸‹ï¼š
- `getAuthorities`: è·å–ç”¨æˆ·æƒé™ï¼Œä¸€èˆ¬æƒ…å†µä¸‹è·å–åˆ°çš„æ˜¯ç”¨æˆ·çš„è§’è‰²ä¿¡æ¯ï¼›
- `getCredentials`: è·å–è¯æ˜ç”¨æˆ·è®¤è¯çš„ä¿¡æ¯ï¼Œé€šå¸¸æƒ…å†µä¸‹è·å–åˆ°çš„æ˜¯å¯†ç ç­‰ä¿¡æ¯ï¼›
- `getDetails`: è·å–ç”¨æˆ·çš„é¢å¤–ä¿¡æ¯ï¼Œï¼ˆè¿™éƒ¨åˆ†ä¿¡æ¯å¯ä»¥æ˜¯æˆ‘ä»¬çš„ç”¨æˆ·è¡¨ä¸­çš„ä¿¡æ¯ï¼‰ï¼›
- `getPrincipal`: è·å–ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼Œåœ¨æœªè®¤è¯çš„æƒ…å†µä¸‹è·å–åˆ°çš„æ˜¯ç”¨æˆ·åï¼Œåœ¨å·²è®¤è¯çš„æƒ…å†µä¸‹è·å–åˆ°çš„æ˜¯ UserDetailsï¼›
- `isAuthenticated`: è·å–å½“å‰ Authentication æ˜¯å¦å·²è®¤è¯ï¼›
- `setAuthenticated`: è®¾ç½®å½“å‰ Authentication æ˜¯å¦å·²è®¤è¯ï¼ˆtrue or falseï¼‰ã€‚

`Authentication`åªæ˜¯å®šä¹‰äº†ä¸€ç§åœ¨SpringSecurityè¿›è¡Œè®¤è¯è¿‡çš„æ•°æ®çš„æ•°æ®å½¢å¼åº”è¯¥æ˜¯æ€ä¹ˆæ ·çš„ï¼Œè¦æœ‰æƒé™ï¼Œè¦æœ‰å¯†ç ï¼Œè¦æœ‰èº«ä»½ä¿¡æ¯ï¼Œè¦æœ‰é¢å¤–ä¿¡æ¯ã€‚

#### AuthenticationManager
```java
public interface AuthenticationManager {
 // è®¤è¯æ–¹æ³•
 Authentication authenticate(Authentication authentication)
   throws AuthenticationException;
}
```
`AuthenticationManager`å®šä¹‰äº†ä¸€ä¸ªè®¤è¯æ–¹æ³•ï¼Œå®ƒå°†ä¸€ä¸ªæœªè®¤è¯çš„`Authentication`ä¼ å…¥ï¼Œè¿”å›ä¸€ä¸ªå·²è®¤è¯çš„`Authentication`ï¼Œé»˜è®¤ä½¿ç”¨çš„å®ç°ç±»ä¸ºï¼š**ProviderManager**ã€‚

æ¥ä¸‹æ¥å¤§å®¶å¯ä»¥æ„æ€ä¸€ä¸‹å¦‚ä½•å°†è¿™å››ä¸ªéƒ¨åˆ†ï¼Œä¸²è”èµ·æ¥ï¼Œæ„æˆSpring Securityè¿›è¡Œè®¤è¯çš„æµç¨‹ï¼š
1. å…ˆæ˜¯ä¸€ä¸ªè¯·æ±‚å¸¦ç€èº«ä»½ä¿¡æ¯è¿›æ¥ï¼›
2. ç»è¿‡**AuthenticationManager**çš„è®¤è¯ï¼›
3. å†é€šè¿‡**SecurityContextHolder**è·å–**SecurityContext**ï¼›
4. æœ€åå°†è®¤è¯åçš„ä¿¡æ¯æ”¾å…¥åˆ°**SecurityContext**ã€‚

### ç¼–ç å‰çš„å‡†å¤‡å·¥ä½œ
é¦–å…ˆå¯¼å…¥å¿…è¦çš„ä¾èµ–ï¼Œæ•°æ®åº“ç›¸å…³çš„ä¾èµ–å¯ä»¥è‡ªè¡Œé€‰æ‹©ä»€ä¹ˆJDBCæ¡†æ¶ï¼Œè¿™é‡Œç”¨myabtis-plus
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>

<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>

<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-validation</artifactId>
</dependency>

<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt</artifactId>
    <version>0.9.0</version>
</dependency>

<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>mybatis-plus-boot-starter</artifactId>
    <version>3.3.0</version>
</dependency>

<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
    <version>5.1.47</version>
</dependency>
```

#### å®šä¹‰åŠ å¯†å™¨Bean
```java
/**
 * å®šä¹‰åŠ å¯†å™¨Bean
 * @return
 */
@Bean
public PasswordEncoder passwordEncoder() {
    return new BCryptPasswordEncoder();
}
```
è¿™ä¸ªBeanæ˜¯ä¸å¿…å¯å°‘çš„ï¼ŒSpring Securityåœ¨è®¤è¯æ“ä½œæ—¶ä¼šä½¿ç”¨æˆ‘ä»¬å®šä¹‰çš„è¿™ä¸ªåŠ å¯†å™¨ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¼šå‡ºç°å¼‚å¸¸ã€‚

#### å®šä¹‰AuthenticationManager
```java
@Bean
public AuthenticationManager authenticationManager() throws Exception {
    return super.authenticationManager();
}

```
è¿™é‡Œå°†Spring Securityè‡ªå¸¦çš„authenticationManagerå£°æ˜æˆBeanï¼Œå£°æ˜å®ƒçš„ä½œç”¨æ˜¯ç”¨å®ƒå¸®æˆ‘ä»¬è¿›è¡Œè®¤è¯æ“ä½œï¼Œè°ƒç”¨è¿™ä¸ªBeançš„authenticateæ–¹æ³•ä¼šç”±Spring Securityè‡ªåŠ¨å¸®æˆ‘ä»¬åšè®¤è¯ã€‚

#### å®ç°UserDetailsService
```java
@Slf4j
@Service("userDetailsService")
public class CustomUserDetailsService implements UserDetailsService {
    @Autowired
    private UserInfoService userService;
    @Autowired
    private RoleInfoService roleInfoService;

    @Override
    public UserDetails loadUserByUsername(String s) throws UsernameNotFoundException {
        log.info("å¼€å§‹ç™»é™†éªŒè¯ï¼Œç”¨æˆ·åä¸º: {}", s);

        // æ ¹æ®ç”¨æˆ·åéªŒè¯ç”¨æˆ·
        QueryWrapper<UserInfo> queryWrapper = new QueryWrapper<>();
        queryWrapper.lambda().eq(UserInfo::getUsername, s);
        UserInfo userInfo = userService.getOne(queryWrapper);
        if (userInfo == null) {
            throw new UsernameNotFoundException("ç”¨æˆ·åä¸å­˜åœ¨ï¼Œç™»é™†å¤±è´¥ã€‚");
        }

        // æ„å»ºUserDetailå¯¹è±¡
        UserDetail userDetail = new UserDetail();
        userDetail.setUserInfo(userInfo);
        List<RoleInfo> roleInfoList = roleInfoService.listRoleByUserId(userInfo.getId());
        userDetail.setRoleInfoList(roleInfoList);
        return userDetail;
    }
}
```
å®ç°UserDetailsServiceçš„æŠ½è±¡æ–¹æ³•å¹¶è¿”å›ä¸€ä¸ªUserDetailså¯¹è±¡ï¼Œè®¤è¯è¿‡ç¨‹ä¸­SpringSecurityä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•è®¿é—®æ•°æ®åº“è¿›è¡Œå¯¹ç”¨æˆ·çš„æœç´¢ï¼Œé€»è¾‘ä»€ä¹ˆéƒ½å¯ä»¥è‡ªå®šä¹‰ï¼Œæ— è®ºæ˜¯ä»æ•°æ®åº“ä¸­è¿˜æ˜¯ä»ç¼“å­˜ä¸­ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦å°†æˆ‘ä»¬æŸ¥è¯¢å‡ºæ¥çš„ç”¨æˆ·ä¿¡æ¯å’Œæƒé™ä¿¡æ¯ç»„è£…æˆä¸€ä¸ªUserDetailsè¿”å›ã€‚

**UserDetails** ä¹Ÿæ˜¯ä¸€ä¸ªå®šä¹‰äº†æ•°æ®å½¢å¼çš„æ¥å£ï¼Œç”¨äºä¿å­˜æˆ‘ä»¬ä»æ•°æ®åº“ä¸­æŸ¥å‡ºæ¥çš„æ•°æ®ï¼Œå…¶åŠŸèƒ½ä¸»è¦æ˜¯éªŒè¯è´¦å·çŠ¶æ€å’Œè·å–æƒé™ã€‚

#### TokenUtil
ç”±äºæˆ‘ä»¬æ˜¯JWTçš„è®¤è¯æ¨¡å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿéœ€è¦ä¸€ä¸ªå¸®æˆ‘ä»¬æ“ä½œTokençš„å·¥å…·ç±»ï¼Œä¸€èˆ¬æ¥è¯´å®ƒå…·æœ‰ä»¥ä¸‹ä¸‰ä¸ªæ–¹æ³•å°±å¤Ÿäº†ï¼š
- åˆ›å»ºtoken
- éªŒè¯token
- åè§£ætokenä¸­çš„ä¿¡æ¯

åœ¨ä¸‹æ–‡ä»£ç é‡Œé¢ï¼ŒJwtProviderå……å½“äº†Tokenå·¥å…·ç±»çš„è§’è‰²ã€‚

### ä»£ç ä¸­çš„å…·ä½“å®ç°
ç”¨SpringSecurityåšJWTè®¤è¯éœ€è¦æˆ‘ä»¬è‡ªå·±å†™ä¸€ä¸ªè¿‡æ»¤å™¨æ¥åšJWTçš„æ ¡éªŒï¼Œç„¶åå°†è¿™ä¸ªè¿‡æ»¤å™¨æ”¾åˆ°å¼€ç¯‡é‚£å¼ å›¾çš„ç»¿è‰²éƒ¨åˆ†ã€‚

åœ¨æˆ‘ä»¬ç¼–å†™è¿™ä¸ªè¿‡æ»¤å™¨ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è¿›è¡Œä¸€ä¸ªè®¤è¯æ“ä½œï¼Œå› ä¸ºæˆ‘ä»¬è¦å…ˆè®¿é—®è®¤è¯æ¥å£æ‹¿åˆ°tokenï¼Œæ‰èƒ½æŠŠtokenæ”¾åˆ°è¯·æ±‚å¤´ä¸Šï¼Œè¿›è¡Œæ¥ä¸‹æ¥è¯·æ±‚ã€‚

#### è®¤è¯æ–¹æ³•
è®¿é—®ä¸€ä¸ªç³»ç»Ÿï¼Œä¸€èˆ¬æœ€å…ˆè®¿é—®çš„æ˜¯è®¤è¯æ–¹æ³•ï¼Œè¿™é‡Œå†™äº†æœ€ç®€ç•¥çš„è®¤è¯éœ€è¦çš„å‡ ä¸ªæ­¥éª¤ï¼Œå› ä¸ºå®é™…ç³»ç»Ÿä¸­æˆ‘ä»¬è¿˜è¦å†™ç™»å½•è®°å½•å•Šï¼Œå‰å°å¯†ç è§£å¯†å•Šè¿™äº›æ“ä½œã€‚
```java
@Service
public class AuthServiceImpl implements AuthService {

    @Autowired
    private AuthenticationManager authenticationManager;
    @Autowired
    private JwtProvider jwtProvider;

    @Override
    public Object login(String loginAccount, String password) {
        // 1 åˆ›å»ºUsernamePasswordAuthenticationToken
        UsernamePasswordAuthenticationToken usernameAuthentication = new UsernamePasswordAuthenticationToken(loginAccount, password);
        // 2 è®¤è¯
        Authentication authentication = authenticationManager.authenticate(usernameAuthentication);
        // 3 ä¿å­˜è®¤è¯ä¿¡æ¯
        SecurityContextHolder.getContext().setAuthentication(authentication);
        // 4 ç”Ÿæˆè‡ªå®šä¹‰token
        UserDetail userDetail = (UserDetail) authentication.getPrincipal();
        AccessToken accessToken = jwtProvider.createToken(userDetail);

        // 5 æ”¾å…¥ç¼“å­˜
        // ...
        return JSONUtil.parseObj(accessToken);
    }
}
```
è¿™é‡Œä¸€å…±äº”ä¸ªæ­¥éª¤ï¼š
1. ä¼ å…¥ç”¨æˆ·åå’Œå¯†ç åˆ›å»ºäº†ä¸€ä¸ª **UsernamePasswordAuthenticationToken** å¯¹è±¡ï¼Œè¿™æ˜¯æˆ‘ä»¬å‰é¢è¯´è¿‡çš„ **Authentication** çš„å®ç°ç±»ï¼Œä¼ å…¥ç”¨æˆ·åå’Œå¯†ç åšæ„é€ å‚æ•°ï¼Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯æˆ‘ä»¬åˆ›å»ºå‡ºæ¥çš„æœªè®¤è¯çš„ **Authentication** å¯¹è±¡ã€‚
2. ä½¿ç”¨æˆ‘ä»¬å…ˆå‰å·²ç»å£°æ˜è¿‡çš„Bean-**authenticationManager**è°ƒç”¨å®ƒçš„**authenticate**æ–¹æ³•è¿›è¡Œè®¤è¯ï¼Œè¿”å›ä¸€ä¸ªè®¤è¯å®Œæˆçš„**Authentication**å¯¹è±¡ã€‚
3. è®¤è¯å®Œæˆæ²¡æœ‰å‡ºç°å¼‚å¸¸ï¼Œå°±ä¼šèµ°åˆ°ç¬¬ä¸‰æ­¥ï¼Œä½¿ç”¨**SecurityContextHolder**è·å–**SecurityContext**ä¹‹åï¼Œå°†è®¤è¯å®Œæˆä¹‹åçš„**Authentication**å¯¹è±¡ï¼Œæ”¾å…¥ä¸Šä¸‹æ–‡å¯¹è±¡ã€‚
4. ä»**Authentication**å¯¹è±¡ä¸­æ‹¿åˆ°æˆ‘ä»¬çš„**UserDetails**å¯¹è±¡ï¼Œä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼Œè®¤è¯åçš„**Authentication**å¯¹è±¡è°ƒç”¨å®ƒçš„getPrincipal()æ–¹æ³•å°±å¯ä»¥æ‹¿åˆ°æˆ‘ä»¬å…ˆå‰æ•°æ®åº“æŸ¥è¯¢åç»„è£…å‡ºæ¥çš„**UserDetails**å¯¹è±¡ï¼Œç„¶ååˆ›å»º**token**ã€‚
5. æŠŠ**UserDetails**å¯¹è±¡æ”¾å…¥ç¼“å­˜ä¸­ï¼Œæ–¹ä¾¿åé¢è¿‡æ»¤å™¨ä½¿ç”¨ã€‚

è¿™æ ·çš„è¯å°±ç®—å®Œæˆäº†ï¼Œæ„Ÿè§‰ä¸Šå¾ˆç®€å•ï¼Œå› ä¸ºä¸»è¦è®¤è¯æ“ä½œéƒ½ä¼šç”±authenticationManager.authenticate()å¸®æˆ‘ä»¬å®Œæˆã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥çœ‹çœ‹æºç ï¼Œä»ä¸­çª¥å¾—Spring Securityæ˜¯å¦‚ä½•å¸®æˆ‘ä»¬åšè¿™ä¸ªè®¤è¯çš„ï¼ˆçœç•¥äº†ä¸€éƒ¨åˆ†ï¼‰ï¼š
```java
// AbstractUserDetailsAuthenticationProvider
public Authentication authenticate(Authentication authentication){
  // æ ¡éªŒæœªè®¤è¯çš„Authenticationå¯¹è±¡é‡Œé¢æœ‰æ²¡æœ‰ç”¨æˆ·å
  String username = (authentication.getPrincipal() == null) ? "NONE_PROVIDED": authentication.getName();  
    
     boolean cacheWasUsed = true;
     // ä»ç¼“å­˜ä¸­å»æŸ¥ç”¨æˆ·åä¸ºXXXçš„å¯¹è±¡
  UserDetails user = this.userCache.getUserFromCache(username);

     // å¦‚æœæ²¡æœ‰å°±è¿›å…¥åˆ°è¿™ä¸ªæ–¹æ³•
  if (user == null) {
   cacheWasUsed = false;

   try {
    // è°ƒç”¨æˆ‘ä»¬é‡å†™UserDetailsServiceçš„loadUserByUsernameæ–¹æ³•
    // æ‹¿åˆ°æˆ‘ä»¬è‡ªå·±ç»„è£…å¥½çš„UserDetailså¯¹è±¡
    user = retrieveUser(username,
      (UsernamePasswordAuthenticationToken) authentication);
   }
   catch (UsernameNotFoundException notFound) {
    logger.debug("User '" + username + "' not found");

    if (hideUserNotFoundExceptions) {
     throw new BadCredentialsException(messages.getMessage(
       "AbstractUserDetailsAuthenticationProvider.badCredentials",
       "Bad credentials"));
    }
    else {
     throw notFound;
    }
   }

   Assert.notNull(user,
     "retrieveUser returned null - a violation of the interface contract");
  }
    
    try {
         // æ ¡éªŒè´¦å·æ˜¯å¦ç¦ç”¨
   preAuthenticationChecks.check(user);
         // æ ¡éªŒæ•°æ®åº“æŸ¥å‡ºæ¥çš„å¯†ç ï¼Œå’Œæˆ‘ä»¬ä¼ å…¥çš„å¯†ç æ˜¯å¦ä¸€è‡´
   additionalAuthenticationChecks(user,
     (UsernamePasswordAuthenticationToken) authentication);
  }
}
```
å…¶ä¸»è¦é€»è¾‘ä¹Ÿæ˜¯æŸ¥æ•°æ®åº“ç„¶åå¯¹æ¯”å¯†ç ã€‚

ç™»å½•æ•ˆæœå¦‚ä¸‹ï¼š  
![png](images/ç™»å½•æ•ˆæœå›¾.png)

æˆ‘ä»¬è¿”å›tokenä¹‹åï¼Œä¸‹æ¬¡è¯·æ±‚å…¶ä»–APIçš„æ—¶å€™å°±è¦åœ¨è¯·æ±‚å¤´ä¸­å¸¦ä¸Šè¿™ä¸ªtokenï¼Œéƒ½æŒ‰ç…§JWTçš„æ ‡å‡†æ¥åšå°±å¯ä»¥ã€‚

#### JWTè¿‡æ»¤å™¨
æœ‰äº†tokenä¹‹åï¼Œæˆ‘ä»¬è¦æŠŠè¿‡æ»¤å™¨æ”¾åœ¨è¿‡æ»¤å™¨é“¾ä¸­ï¼Œç”¨äºè§£ætokenï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰sessionï¼Œæ‰€ä»¥æˆ‘ä»¬æ¯æ¬¡å»è¾¨åˆ«è¿™æ˜¯å“ªä¸ªç”¨æˆ·çš„è¯·æ±‚çš„æ—¶å€™ï¼Œéƒ½æ˜¯æ ¹æ®è¯·æ±‚ä¸­çš„tokenæ¥è§£æå‡ºæ¥å½“å‰æ˜¯å“ªä¸ªç”¨æˆ·ã€‚

æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªè¿‡æ»¤å™¨å»æ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼Œå‰æ–‡æˆ‘ä»¬ä¹Ÿè¯´è¿‡ï¼Œè¿™ä¸ªè¿‡æ»¤å™¨æˆ‘ä»¬ä¼šæ”¾åœ¨ç»¿è‰²éƒ¨åˆ†ç”¨æ¥æ›¿ä»£**UsernamePasswordAuthenticationFilter**ï¼Œæ‰€ä»¥æˆ‘ä»¬æ–°å»ºä¸€ä¸ª**JwtAuthenticationTokenFilter**ï¼Œç„¶åå°†å®ƒæ³¨å†Œä¸ºBeanï¼Œå¹¶åœ¨ç¼–å†™é…ç½®æ–‡ä»¶çš„æ—¶å€™éœ€è¦åŠ ä¸Šè¿™ä¸ªï¼š
```java
@Bean
public JwtAuthenticationTokenFilter jwtAuthenticationTokenFilter() {
    return new JwtAuthenticationTokenFilter();
}

@Override
protected void configure(HttpSecurity http) throws Exception {
    http.addFilterBefore(jwtAuthenticationTokenFilter(),UsernamePasswordAuthenticationFilter.class);
}
```
addFilterBeforeçš„è¯­ä¹‰æ˜¯æ·»åŠ ä¸€ä¸ªFilteråˆ°XXXFilterä¹‹å‰ï¼Œæ”¾åœ¨è¿™é‡Œå°±æ˜¯æŠŠ**JwtAuthenticationTokenFilter**æ”¾åœ¨**UsernamePasswordAuthenticationFilter**ä¹‹å‰ï¼Œå› ä¸ºfilterçš„æ‰§è¡Œä¹Ÿæ˜¯æœ‰é¡ºåºçš„ï¼Œæˆ‘ä»¬å¿…é¡»è¦æŠŠæˆ‘ä»¬çš„filteræ”¾åœ¨è¿‡æ»¤å™¨é“¾ä¸­ç»¿è‰²çš„éƒ¨åˆ†æ‰ä¼šèµ·åˆ°è‡ªåŠ¨è®¤è¯çš„æ•ˆæœã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥çœ‹çœ‹JwtAuthenticationTokenFilterçš„å…·ä½“å®ç°äº†ï¼š
```java
@Slf4j
public class JwtAuthenticationTokenFilter extends OncePerRequestFilter {

    @Autowired
    private JwtProvider jwtProvider;
    @Autowired
    private JwtProperties jwtProperties;

    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain chain) throws ServletException, IOException {
        log.info("JWTè¿‡æ»¤å™¨é€šè¿‡æ ¡éªŒè¯·æ±‚å¤´tokenè¿›è¡Œè‡ªåŠ¨ç™»å½•...");

        // æ‹¿åˆ°Authorizationè¯·æ±‚å¤´å†…çš„ä¿¡æ¯
        String authToken = jwtProvider.getToken(request);

        // åˆ¤æ–­ä¸€ä¸‹å†…å®¹æ˜¯å¦ä¸ºç©º
        if (StrUtil.isNotEmpty(authToken) && authToken.startsWith(jwtProperties.getTokenPrefix())) {
            // å»æ‰tokenå‰ç¼€(Bearer )ï¼Œæ‹¿åˆ°çœŸå®token
            authToken = authToken.substring(jwtProperties.getTokenPrefix().length());

            // æ‹¿åˆ°tokené‡Œé¢çš„ç™»å½•è´¦å·
            String loginAccount = jwtProvider.getSubjectFromToken(authToken);

            if (StrUtil.isNotEmpty(loginAccount) && SecurityContextHolder.getContext().getAuthentication() == null) {
                // ç¼“å­˜é‡ŒæŸ¥è¯¢ç”¨æˆ·ï¼Œä¸å­˜åœ¨éœ€è¦é‡æ–°ç™»é™†
                //UserDetail userDetails = caffeineCache.get(CacheName.USER, loginAccount, UserDetail.class);
                UserDetail userDetails = null;

                // æ‹¿åˆ°ç”¨æˆ·ä¿¡æ¯åéªŒè¯ç”¨æˆ·ä¿¡æ¯ä¸token
                if (userDetails != null && jwtProvider.validateToken(authToken, userDetails)) {

                    // ç»„è£…authenticationå¯¹è±¡ï¼Œæ„é€ å‚æ•°æ˜¯Principal Credentials ä¸ Authorities
                    // åé¢çš„æ‹¦æˆªå™¨é‡Œé¢ä¼šç”¨åˆ° grantedAuthorities æ–¹æ³•
                    UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken(userDetails, userDetails.getPassword(), userDetails.getAuthorities());

                    // å°†authenticationä¿¡æ¯æ”¾å…¥åˆ°ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­
                    SecurityContextHolder.getContext().setAuthentication(authentication);

                    log.info("JWTè¿‡æ»¤å™¨é€šè¿‡æ ¡éªŒè¯·æ±‚å¤´tokenè‡ªåŠ¨ç™»å½•æˆåŠŸ, user : {}", userDetails.getUsername());
                }
            }
        }
        chain.doFilter(request, response);
    }
}
```
1. æ‹¿åˆ°Authorizationè¯·æ±‚å¤´å¯¹åº”çš„tokenä¿¡æ¯ã€‚
2. å»æ‰tokençš„å¤´éƒ¨(Bearer )ã€‚
3. è§£ætokenï¼Œæ‹¿åˆ°æˆ‘ä»¬æ”¾åœ¨é‡Œé¢çš„ç™»é™†è´¦å·ã€‚
4. å› ä¸ºæˆ‘ä»¬ä¹‹å‰ç™»é™†è¿‡ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥ä»ç¼“å­˜é‡Œé¢æ‹¿æˆ‘ä»¬çš„UserDetailä¿¡æ¯å³å¯ã€‚
5. æŸ¥çœ‹æ˜¯å¦UserDetailä¸ºnullï¼Œä»¥åŠæŸ¥çœ‹tokenæ˜¯å¦è¿‡æœŸï¼ŒUserDetailç”¨æˆ·åä¸tokenä¸­çš„æ˜¯å¦ä¸€ç›´ã€‚
6. ç»„è£…ä¸€ä¸ªauthenticationå¯¹è±¡ï¼ŒæŠŠå®ƒæ”¾åœ¨ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­ï¼Œè¿™æ ·åé¢çš„è¿‡æ»¤å™¨çœ‹åˆ°æˆ‘ä»¬ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­æœ‰authenticationå¯¹è±¡ï¼Œå°±ç›¸å½“äºæˆ‘ä»¬å·²ç»è®¤è¯è¿‡äº†ã€‚

è¿™æ ·çš„è¯ï¼Œæ¯ä¸€ä¸ªå¸¦æœ‰æ­£ç¡®tokençš„è¯·æ±‚è¿›æ¥ä¹‹åï¼Œéƒ½ä¼šæ‰¾åˆ°å®ƒçš„è´¦å·ä¿¡æ¯ï¼Œå¹¶æ”¾åœ¨ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨SecurityContextHolderå¾ˆæ–¹ä¾¿çš„æ‹¿åˆ°ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­çš„Authenticationå¯¹è±¡ã€‚


ç»“åˆè®¤è¯æ–¹æ³•ï¼Œæˆ‘ä»¬çš„é€»è¾‘é“¾å°±å˜æˆäº†ï¼š
ç™»å½•ğŸ‘‰æ‹¿åˆ°tokenğŸ‘‰è¯·æ±‚å¸¦ä¸ŠtokenğŸ‘‰JWTè¿‡æ»¤å™¨æ‹¦æˆªğŸ‘‰æ ¡éªŒtokenğŸ‘‰å°†ä»ç¼“å­˜ä¸­æŸ¥å‡ºæ¥çš„å¯¹è±¡æ”¾åˆ°ä¸Šä¸‹æ–‡ä¸­

## SpringSecurityåŠ¨æ€é‰´æƒ
### SpringSecurityçš„é‰´æƒåŸç†
![png](images/securityåŸºæœ¬åŸç†å›¾.jpeg)  
æ•´ä¸ªè®¤è¯çš„è¿‡ç¨‹å…¶å®ä¸€ç›´åœ¨å›´ç»•å›¾ä¸­è¿‡æ»¤é“¾çš„ç»¿è‰²éƒ¨åˆ†ï¼Œè€ŒåŠ¨æ€é‰´æƒä¸»è¦æ˜¯å›´ç»•å…¶æ©™è‰²éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯å›¾ä¸Šæ ‡çš„ï¼š**FilterSecurityInterceptor**

#### FilterSecurityInterceptor
æƒ³çŸ¥é“æ€ä¹ˆåŠ¨æ€é‰´æƒé¦–å…ˆæˆ‘ä»¬è¦ææ˜ç™½SpringSecurityçš„é‰´æƒé€»è¾‘ï¼Œä»ä¸Šå›¾ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºï¼š**FilterSecurityInterceptor**æ˜¯è¿™ä¸ªè¿‡æ»¤é“¾çš„æœ€åä¸€ç¯ï¼Œè€Œè®¤è¯ä¹‹åå°±æ˜¯é‰´æƒï¼Œæ‰€ä»¥æˆ‘ä»¬çš„**FilterSecurityInterceptor**ä¸»è¦æ˜¯è´Ÿè´£é‰´æƒè¿™éƒ¨åˆ†ã€‚

ä¸€ä¸ªè¯·æ±‚å®Œæˆäº†è®¤è¯ï¼Œä¸”æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ä¹‹åå°±ä¼šåˆ°è¾¾**FilterSecurityInterceptor**æ‰€è´Ÿè´£çš„é‰´æƒéƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯è¯´é‰´æƒçš„å…¥å£å°±åœ¨**FilterSecurityInterceptor**ã€‚

å…ˆæ¥çœ‹çœ‹**FilterSecurityInterceptor**çš„å®šä¹‰å’Œä¸»è¦æ–¹æ³•ï¼š
```java
public class FilterSecurityInterceptor extends AbstractSecurityInterceptor implements
  Filter {

            public void doFilter(ServletRequest request, ServletResponse response,
                    FilterChain chain) throws IOException, ServletException {
                FilterInvocation fi = new FilterInvocation(request, response, chain);
                invoke(fi);
            }
}
```
ä¸Šæ–‡ä»£ç å¯ä»¥çœ‹å‡º`FilterSecurityInterceptor`æ˜¯å®ç°äº†æŠ½è±¡ç±»`AbstractSecurityInterceptor`çš„ä¸€ä¸ªå®ç°ç±»ï¼Œè¿™ä¸ª`AbstractSecurityInterceptor`ä¸­é¢„å…ˆå†™å¥½äº†ä¸€æ®µå¾ˆé‡è¦çš„ä»£ç ï¼ˆåé¢ä¼šè¯´åˆ°ï¼‰ã€‚

`FilterSecurityInterceptor`çš„ä¸»è¦æ–¹æ³•æ˜¯doFilteræ–¹æ³•ï¼Œè¿‡æ»¤å™¨çš„ç‰¹æ€§å¤§å®¶åº”è¯¥éƒ½çŸ¥é“ï¼Œè¯·æ±‚è¿‡æ¥ä¹‹åä¼šæ‰§è¡Œè¿™ä¸ªdoFilteræ–¹æ³•ï¼Œ`FilterSecurityInterceptor`çš„doFilteræ–¹æ³•å‡ºå¥‡çš„ç®€å•ï¼Œæ€»å…±åªæœ‰ä¸¤è¡Œï¼š

ç¬¬ä¸€è¡Œæ˜¯åˆ›å»ºäº†ä¸€ä¸ª`FilterInvocation`å¯¹è±¡ï¼Œè¿™ä¸ª`FilterInvocation`å¯¹è±¡ä½ å¯ä»¥å½“ä½œå®ƒå°è£…äº†requestï¼Œå®ƒçš„ä¸»è¦å·¥ä½œå°±æ˜¯æ‹¿è¯·æ±‚é‡Œé¢çš„ä¿¡æ¯ï¼Œæ¯”å¦‚è¯·æ±‚çš„URIã€‚  
ç¬¬äºŒè¡Œå°±è°ƒç”¨äº†è‡ªèº«çš„invokeæ–¹æ³•ï¼Œå¹¶å°†`FilterInvocation`å¯¹è±¡ä¼ å…¥ã€‚

æ‰€ä»¥ä¸»è¦é€»è¾‘è‚¯å®šæ˜¯åœ¨è¿™ä¸ªinvokeæ–¹æ³•é‡Œé¢äº†ï¼Œæ¥æ‰“å¼€çœ‹çœ‹ï¼š
```java
public void invoke(FilterInvocation fi) throws IOException, ServletException {
        if ((fi.getRequest() != null)
                && (fi.getRequest().getAttribute(FILTER_APPLIED) != null)
                && observeOncePerRequest) {
            // filter already applied to this request and user wants us to observe
            // once-per-request handling, so don't re-do security checking
            fi.getChain().doFilter(fi.getRequest(), fi.getResponse());
        }
        else {
            // first time this request being called, so perform security checking
            if (fi.getRequest() != null && observeOncePerRequest) {
                fi.getRequest().setAttribute(FILTER_APPLIED, Boolean.TRUE);
            }

            // è¿›å…¥é‰´æƒ
            InterceptorStatusToken token = super.beforeInvocation(fi);

            try {
                fi.getChain().doFilter(fi.getRequest(), fi.getResponse());
            }
            finally {
                super.finallyInvocation(token);
            }

            super.afterInvocation(token, null);
        }
    }
```
invokeæ–¹æ³•ä¸­åªæœ‰ä¸€ä¸ª`if-else`ï¼Œä¸€èˆ¬éƒ½æ˜¯ä¸æ»¡è¶³ifä¸­çš„é‚£ä¸‰ä¸ªæ¡ä»¶çš„ï¼Œç„¶åæ‰§è¡Œé€»è¾‘ä¼šæ¥åˆ°elseã€‚  
elseçš„ä»£ç ä¹Ÿå¯ä»¥æ¦‚æ‹¬ä¸ºä¸¤éƒ¨åˆ†ï¼š
1. è°ƒç”¨äº†super.beforeInvocation(fi)ã€‚
2. è°ƒç”¨å®Œä¹‹åè¿‡æ»¤å™¨ç»§ç»­å¾€ä¸‹èµ°ã€‚

ç¬¬äºŒæ­¥å¯ä»¥ä¸çœ‹ï¼Œæ¯ä¸ªè¿‡æ»¤å™¨éƒ½æœ‰è¿™ä¹ˆä¸€æ­¥ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸»è¦çœ‹`super.beforeInvocation(fi)`ï¼Œå‰æ–‡å·²ç»è¯´è¿‡ï¼ŒFilterSecurityInterceptorå®ç°äº†æŠ½è±¡ç±»AbstractSecurityInterceptorï¼Œæ‰€ä»¥è¿™ä¸ªé‡Œsuperå…¶å®æŒ‡çš„å°±æ˜¯AbstractSecurityInterceptorï¼Œé‚£è¿™æ®µä»£ç å…¶å®è°ƒç”¨äº†AbstractSecurityInterceptor.beforeInvocation(fi)ï¼Œ
å‰æ–‡è¯´è¿‡AbstractSecurityInterceptorä¸­æœ‰ä¸€æ®µå¾ˆé‡è¦çš„ä»£ç å°±æ˜¯è¿™ä¸€æ®µï¼Œé‚£æˆ‘ä»¬ç»§ç»­æ¥çœ‹è¿™ä¸ªbeforeInvocation(fi)æ–¹æ³•çš„æºç ï¼š
```java
protected InterceptorStatusToken beforeInvocation(Object object) {
        Assert.notNull(object, "Object was null");
        final boolean debug = logger.isDebugEnabled();

        if (!getSecureObjectClass().isAssignableFrom(object.getClass())) {
            throw new IllegalArgumentException(
                    "Security invocation attempted for object "
                            + object.getClass().getName()
                            + " but AbstractSecurityInterceptor only configured to support secure objects of type: "
                            + getSecureObjectClass());
        }

        Collection<ConfigAttribute> attributes = this.obtainSecurityMetadataSource()
                .getAttributes(object);

        Authentication authenticated = authenticateIfRequired();

        try {
            // é‰´æƒéœ€è¦è°ƒç”¨çš„æ¥å£
            this.accessDecisionManager.decide(authenticated, object, attributes);
        }
        catch (AccessDeniedException accessDeniedException) {
            publishEvent(new AuthorizationFailureEvent(object, attributes, authenticated,
                    accessDeniedException));

            throw accessDeniedException;
        }

    }
```
æºç è¾ƒé•¿ï¼Œè¿™é‡Œç²¾ç®€äº†ä¸­é—´çš„ä¸€éƒ¨åˆ†ï¼Œè¿™æ®µä»£ç å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰æ­¥ï¼š
1. æ‹¿åˆ°äº†ä¸€ä¸ª`Collection<ConfigAttribute>`å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯ä¸€ä¸ªListï¼Œå…¶å®é‡Œé¢å°±æ˜¯æˆ‘ä»¬åœ¨é…ç½®ä¸­é…ç½®çš„è¿‡æ»¤è§„åˆ™ã€‚
2. æ‹¿åˆ°äº†`Authentication`ï¼Œè¿™é‡Œæ˜¯è°ƒç”¨`authenticateIfRequired`æ–¹æ³•æ‹¿åˆ°äº†ï¼Œå…¶å®é‡Œé¢è¿˜æ˜¯é€šè¿‡`SecurityContextHolder`æ‹¿åˆ°çš„ã€‚
3. è°ƒç”¨äº†`accessDecisionManager.decide(authenticated, object, attributes)`ï¼Œå‰ä¸¤æ­¥éƒ½æ˜¯å¯¹`decide`æ–¹æ³•åšå‚æ•°çš„å‡†å¤‡ï¼Œç¬¬ä¸‰æ­¥æ‰æ˜¯æ­£å¼å»åˆ°é‰´æƒçš„é€»è¾‘ï¼Œæ—¢ç„¶è¿™é‡Œé¢æ‰æ˜¯çœŸæ­£é‰´æƒçš„é€»è¾‘ï¼Œé‚£ä¹Ÿå°±æ˜¯è¯´é‰´æƒå…¶å®æ˜¯`accessDecisionManager`åœ¨åšã€‚

#### AccessDecisionManager
å‰é¢é€šè¿‡æºç æˆ‘ä»¬çœ‹åˆ°äº†é‰´æƒçš„çœŸæ­£å¤„ç†è€…ï¼šAccessDecisionManagerï¼Œæ˜¯ä¸æ˜¯è§‰å¾—ä¸€å±‚æ¥ç€ä¸€å±‚ï¼Œå°±åƒå¥—å¨ƒä¸€æ ·ï¼Œåˆ«æ€¥ï¼Œä¸‹é¢è¿˜æœ‰ã€‚å…ˆæ¥çœ‹çœ‹æºç æ¥å£å®šä¹‰ï¼š
```java
public interface AccessDecisionManager {
// ä¸»è¦é‰´æƒæ–¹æ³•
void decide(Authentication authentication, Object object,
            Collection<ConfigAttribute> configAttributes) throws AccessDeniedException,
        InsufficientAuthenticationException;

boolean supports(ConfigAttribute attribute);

boolean supports(Class<?> clazz);
}
```
`AccessDecisionManager`æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒå£°æ˜äº†ä¸‰ä¸ªæ–¹æ³•ï¼Œé™¤äº†ç¬¬ä¸€ä¸ªé‰´æƒæ–¹æ³•ä»¥å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªæ˜¯è¾…åŠ©æ€§çš„æ–¹æ³•ï¼Œå…¶ä½œç”¨éƒ½æ˜¯ç”„åˆ«decideæ–¹æ³•ä¸­å‚æ•°çš„æœ‰æ•ˆæ€§ã€‚  
å®ƒä¸»è¦æœ‰ä¸‰ä¸ªå®ç°ç±»ï¼Œåˆ†åˆ«ä»£è¡¨äº†ä¸‰ç§ä¸åŒçš„é‰´æƒé€»è¾‘ï¼š
- `AffirmativeBased`ï¼šä¸€ç¥¨é€šè¿‡ï¼Œåªè¦æœ‰ä¸€ç¥¨é€šè¿‡å°±ç®—é€šè¿‡ï¼Œé»˜è®¤æ˜¯å®ƒã€‚
- `UnanimousBased`ï¼šä¸€ç¥¨åå¯¹ï¼Œåªè¦æœ‰ä¸€ç¥¨åå¯¹å°±ä¸èƒ½é€šè¿‡ã€‚
- `ConsensusBased`ï¼šå°‘æ•°ç¥¨æœä»å¤šæ•°ç¥¨ã€‚

è¿™é‡Œçš„è¡¨è¿°ä¸ºä»€ä¹ˆè¦ç”¨ç¥¨å‘¢ï¼Ÿå› ä¸ºåœ¨å®ç°ç±»é‡Œé¢é‡‡ç”¨äº†å§”æ‰˜çš„å½¢å¼ï¼Œå°†è¯·æ±‚å§”æ‰˜ç»™æŠ•ç¥¨å™¨ï¼Œæ¯ä¸ªæŠ•ç¥¨å™¨æ‹¿ç€è¿™ä¸ªè¯·æ±‚æ ¹æ®è‡ªèº«çš„é€»è¾‘æ¥è®¡ç®—å‡ºèƒ½ä¸èƒ½é€šè¿‡ç„¶åè¿›è¡ŒæŠ•ç¥¨ã€‚

ä¹Ÿå°±æ˜¯è¯´è¿™ä¸‰ä¸ªå®ç°ç±»ï¼Œå…¶å®è¿˜ä¸æ˜¯çœŸæ­£åˆ¤æ–­è¯·æ±‚èƒ½ä¸èƒ½é€šè¿‡çš„ç±»ï¼ŒçœŸæ­£åˆ¤æ–­è¯·æ±‚æ˜¯å¦é€šè¿‡çš„æ˜¯æŠ•ç¥¨å™¨ï¼Œç„¶åå®ç°ç±»æŠŠæŠ•ç¥¨å™¨çš„ç»“æœç»¼åˆèµ·æ¥æ¥å†³å®šåˆ°åº•èƒ½ä¸èƒ½é€šè¿‡ã€‚

å®ç°ç±»æŠŠæŠ•ç¥¨å™¨çš„ç»“æœç»¼åˆèµ·æ¥è¿›è¡Œå†³å®šï¼Œä¹Ÿå°±æ˜¯è¯´æŠ•ç¥¨å™¨å¯ä»¥æ”¾å…¥å¤šä¸ªï¼Œæ¯ä¸ªå®ç°ç±»é‡Œçš„æŠ•ç¥¨å™¨æ•°é‡å–å†³äºæ„é€ çš„æ—¶å€™æ”¾å…¥äº†å¤šå°‘æŠ•ç¥¨å™¨ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹é»˜è®¤çš„`AffirmativeBased`çš„æºç ï¼š
```java
public class AffirmativeBased extends AbstractAccessDecisionManager {

    public AffirmativeBased(List<AccessDecisionVoter<?>> decisionVoters) {
        super(decisionVoters);
    }

    // æ‹¿åˆ°æ‰€æœ‰çš„æŠ•ç¥¨å™¨ï¼Œå¾ªç¯éå†è¿›è¡ŒæŠ•ç¥¨
    public void decide(Authentication authentication, Object object,
                       Collection<ConfigAttribute> configAttributes) throws AccessDeniedException {
        int deny = 0;

        for (AccessDecisionVoter voter : getDecisionVoters()) {
            int result = voter.vote(authentication, object, configAttributes);

            if (logger.isDebugEnabled()) {
                logger.debug("Voter: " + voter + ", returned: " + result);
            }

            switch (result) {
                case AccessDecisionVoter.ACCESS_GRANTED:
                    return;

                case AccessDecisionVoter.ACCESS_DENIED:
                    deny++;

                    break;

                default:
                    break;
            }
        }

        if (deny > 0) {
            throw new AccessDeniedException(messages.getMessage(
                    "AbstractAccessDecisionManager.accessDenied", "Access is denied"));
        }

        // To get this far, every AccessDecisionVoter abstained
        checkAllowIfAllAbstainDecisions();
    }
}
```
`AffirmativeBased`çš„æ„é€ æ˜¯ä¼ å…¥æŠ•ç¥¨å™¨Listï¼Œå…¶ä¸»è¦é‰´æƒé€»è¾‘äº¤ç»™æŠ•ç¥¨å™¨å»åˆ¤æ–­ï¼ŒæŠ•ç¥¨å™¨è¿”å›ä¸åŒçš„æ•°å­—ä»£è¡¨ä¸åŒçš„ç»“æœï¼Œç„¶å`AffirmativeBased`æ ¹æ®è‡ªèº«ä¸€ç¥¨é€šè¿‡çš„ç­–ç•¥å†³å®šæ”¾è¡Œè¿˜æ˜¯æŠ›å‡ºå¼‚å¸¸ã€‚

`AffirmativeBased`é»˜è®¤ä¼ å…¥çš„æ„é€ å™¨åªæœ‰ä¸€ä¸ª->`WebExpressionVoter`ï¼Œè¿™ä¸ªæ„é€ å™¨ä¼šæ ¹æ®ä½ åœ¨é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®è¿›è¡Œé€»è¾‘å¤„ç†å¾—å‡ºæŠ•ç¥¨ç»“æœã€‚

æ‰€ä»¥SpringSecurityé»˜è®¤çš„é‰´æƒé€»è¾‘å°±æ˜¯æ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®è¿›è¡Œé‰´æƒï¼Œè¿™æ˜¯ç¬¦åˆæˆ‘ä»¬ç°æœ‰è®¤çŸ¥çš„ã€‚

### åŠ¨æ€é‰´æƒå®ç°
æ—¢ç„¶æ˜¯åŠ¨æ€é‰´æƒäº†ï¼Œé‚£æˆ‘ä»¬çš„æƒé™URIè‚¯å®šæ˜¯æ”¾åœ¨æ•°æ®åº“ä¸­äº†ï¼Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯å®æ—¶çš„åœ¨æ•°æ®åº“ä¸­å»è¯»å–ä¸åŒè§’è‰²å¯¹åº”çš„æƒé™ç„¶åä¸å½“å‰ç™»å½•çš„ç”¨æˆ·åšä¸ªæ¯”è¾ƒã€‚

é‚£æˆ‘ä»¬è¦åšåˆ°è¿™ä¸€æ­¥å¯ä»¥æƒ³äº›æ–¹æ¡ˆï¼Œæ¯”å¦‚ï¼š
- ç›´æ¥é‡å†™ä¸€ä¸ª`AccessDecisionManager`ï¼Œå°†å®ƒç”¨ä½œé»˜è®¤çš„`AccessDecisionManager`ï¼Œå¹¶åœ¨é‡Œé¢ç›´æ¥å†™å¥½é‰´æƒé€»è¾‘ã€‚
- å†æ¯”å¦‚é‡å†™ä¸€ä¸ªæŠ•ç¥¨å™¨ï¼Œå°†å®ƒæ”¾åˆ°é»˜è®¤çš„`AccessDecisionManager`é‡Œé¢ï¼Œå’Œä¹‹å‰ä¸€æ ·ç”¨æŠ•ç¥¨å™¨é‰´æƒã€‚
- ç›´æ¥å»åšFilterSecurityInterceptorçš„æ”¹åŠ¨ã€‚

æˆ‘ä»¬é€‰ç¬¬äºŒç§æ–¹å¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦å†™ä¸€ä¸ªæ–°çš„æŠ•ç¥¨å™¨ï¼Œåœ¨è¿™ä¸ªæŠ•ç¥¨å™¨é‡Œé¢æ‹¿åˆ°å½“å‰ç”¨æˆ·çš„è§’è‰²ï¼Œä½¿å…¶å’Œå½“å‰è¯·æ±‚æ‰€éœ€è¦çš„è§’è‰²åšä¸ªå¯¹æ¯”ã€‚

å•å•æ˜¯è¿™æ ·è¿˜ä¸å¤Ÿï¼Œå› ä¸ºæˆ‘ä»¬å¯èƒ½åœ¨é…ç½®æ–‡ä»¶ä¸­ä¹Ÿé…ç½®çš„æœ‰ä¸€äº›æ”¾è¡Œçš„æƒé™ï¼Œæ¯”å¦‚ç™»å½•URIå°±æ˜¯æ”¾è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ç»§ç»­ä½¿ç”¨æˆ‘ä»¬ä¸Šæ–‡æ‰€æåˆ°çš„`WebExpressionVoter`ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘è¦è‡ªå®šä¹‰æƒé™+é…ç½®æ–‡ä»¶åŒè¡Œçš„æ¨¡å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„`AccessDecisionManager`é‡Œé¢å°±ä¼šæœ‰ä¸¤ä¸ªæŠ•ç¥¨å™¨ï¼š`WebExpressionVoter`å’Œ**è‡ªå®šä¹‰çš„æŠ•ç¥¨å™¨**ã€‚

ç´§æ¥ç€æˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘å»ä½¿ç”¨ä»€ä¹ˆæ ·çš„æŠ•ç¥¨ç­–ç•¥ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯`UnanimousBased`ä¸€ç¥¨åå¯¹ç­–ç•¥ï¼Œè€Œæ²¡æœ‰ä½¿ç”¨é»˜è®¤çš„ä¸€ç¥¨é€šè¿‡ç­–ç•¥ï¼Œå› ä¸ºåœ¨æˆ‘ä»¬çš„é…ç½®ä¸­é…ç½®äº†é™¤äº†ç™»å½•è¯·æ±‚ä»¥å¤–çš„å…¶ä»–è¯·æ±‚éƒ½æ˜¯éœ€è¦è®¤è¯çš„ï¼Œè¿™ä¸ªé€»è¾‘ä¼šè¢«`WebExpressionVoter`å¤„ç†ï¼Œå¦‚æœä½¿ç”¨äº†ä¸€ç¥¨é€šè¿‡ç­–ç•¥ï¼Œé‚£æˆ‘ä»¬å»è®¿é—®è¢«ä¿æŠ¤çš„APIçš„æ—¶å€™ï¼Œ`WebExpressionVoter`å‘ç°å½“å‰è¯·æ±‚è®¤è¯äº†ï¼Œå°±ç›´æ¥æŠ•äº†èµæˆç¥¨ï¼Œä¸”å› ä¸ºæ˜¯ä¸€ç¥¨é€šè¿‡ç­–ç•¥ï¼Œè¿™ä¸ªè¯·æ±‚å°±èµ°ä¸åˆ°æˆ‘ä»¬è‡ªå®šä¹‰çš„æŠ•ç¥¨å™¨äº†ã€‚

æ³¨ï¼šä½ ä¹Ÿå¯ä»¥ä¸ç”¨é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®ï¼Œå°†ä½ çš„è‡ªå®šä¹‰æƒé™é…ç½®éƒ½æ”¾åœ¨æ•°æ®åº“ä¸­ï¼Œç„¶åç»Ÿä¸€äº¤ç»™ä¸€ä¸ªæŠ•ç¥¨å™¨æ¥å¤„ç†ã€‚

#### é‡æ–°æ„é€ AccessDecisionManager
é¦–å…ˆé‡æ–°æ„é€ `AccessDecisionManager`ï¼Œ å› ä¸ºæŠ•ç¥¨å™¨æ˜¯ç³»ç»Ÿå¯åŠ¨çš„æ—¶å€™è‡ªåŠ¨æ·»åŠ è¿›å»çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æƒ³å¤šåŠ å…¥ä¸€ä¸ªæ„é€ å™¨å¿…é¡»è‡ªå·±é‡æ–°æ„å»º`AccessDecisionManager`ï¼Œç„¶åå°†å®ƒæ”¾åˆ°é…ç½®ä¸­å»ã€‚

è€Œä¸”æˆ‘ä»¬çš„æŠ•ç¥¨ç­–ç•¥å·²ç»æ”¹å˜äº†ï¼Œè¦ç”±`AffirmativeBased`æ¢æˆ`UnanimousBased`ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥æ˜¯å¿…ä¸å¯å°‘çš„ã€‚å¹¶ä¸”æˆ‘ä»¬è¿˜è¦è‡ªå®šä¹‰ä¸€ä¸ªæŠ•ç¥¨å™¨èµ·æ¥ï¼Œå°†å®ƒæ³¨å†ŒæˆBeanï¼Œ`AccessDecisionProcessor`å°±æ˜¯æˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰çš„æŠ•ç¥¨å™¨ã€‚
```java
@Bean
public AccessDecisionVoter<FilterInvocation> accessDecisionProcessor() {
    return new AccessDecisionProcessor();
}

@Bean
public AccessDecisionManager accessDecisionManager() {
    // æ„é€ ä¸€ä¸ªæ–°çš„AccessDecisionManager æ”¾å…¥ä¸¤ä¸ªæŠ•ç¥¨å™¨
    List<AccessDecisionVoter<?>> decisionVoters = Arrays.asList(new WebExpressionVoter(), accessDecisionProcessor());
    return new UnanimousBased(decisionVoters);
}
```
