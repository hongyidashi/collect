# Spring Security çŸ¥è¯†ç‚¹

ç›®å½•
+ [SpringSecurity+JWT](#SpringSecurity+JWT)
  + [SpringSecurityçš„å·¥ä½œæµç¨‹](#SpringSecurityçš„å·¥ä½œæµç¨‹)
  + [SpringSecurityçš„é‡è¦æ¦‚å¿µ](#SpringSecurityçš„é‡è¦æ¦‚å¿µ)
  + [ç¼–ç å‰çš„å‡†å¤‡å·¥ä½œ](#ç¼–ç å‰çš„å‡†å¤‡å·¥ä½œ)
  + [ä»£ç ä¸­çš„å…·ä½“å®ç°](#ä»£ç ä¸­çš„å…·ä½“å®ç°)

## SpringSecurity+JWT
### SpringSecurityçš„å·¥ä½œæµç¨‹
**Spring Security çš„webåŸºç¡€æ˜¯Filtersï¼šå³é€šè¿‡ä¸€å±‚å±‚çš„Filtersæ¥å¯¹webè¯·æ±‚åšå¤„ç†**ã€‚

ä¸€ä¸ªwebè¯·æ±‚ä¼šç»è¿‡ä¸€æ¡è¿‡æ»¤å™¨é“¾ï¼Œåœ¨ç»è¿‡è¿‡æ»¤å™¨é“¾çš„è¿‡ç¨‹ä¸­ä¼šå®Œæˆè®¤è¯ä¸æˆæƒï¼Œå¦‚æœä¸­é—´å‘ç°è¿™æ¡è¯·æ±‚æœªè®¤è¯æˆ–è€…æœªæˆæƒï¼Œä¼šæ ¹æ®è¢«ä¿æŠ¤APIçš„æƒé™å»æŠ›å‡ºå¼‚å¸¸ï¼Œç„¶åç”±å¼‚å¸¸å¤„ç†å™¨å»å¤„ç†è¿™äº›å¼‚å¸¸ã€‚

![png](images/securityåŸºæœ¬åŸç†å›¾.jpeg)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸€ä¸ªè¯·æ±‚æƒ³è¦è®¿é—®åˆ°APIå°±ä¼šä»¥ä»å·¦åˆ°å³çš„å½¢å¼ç»è¿‡è“çº¿æ¡†æ¡†é‡Œé¢çš„è¿‡æ»¤å™¨ï¼Œå…¶ä¸­ç»¿è‰²éƒ¨åˆ†æ˜¯è´Ÿè´£è®¤è¯çš„è¿‡æ»¤å™¨ï¼Œè“è‰²éƒ¨åˆ†è´Ÿè´£å¼‚å¸¸å¤„ç†ï¼Œæ©™è‰²éƒ¨åˆ†åˆ™æ˜¯è´Ÿè´£æˆæƒã€‚

å›¾ä¸­çš„è¿™ä¸¤ä¸ªç»¿è‰²è¿‡æ»¤å™¨ä¸ä¼šå»è¯´ï¼Œå› ä¸ºè¿™æ˜¯Spring Securityå¯¹formè¡¨å•è®¤è¯å’ŒBasicè®¤è¯å†…ç½®çš„ä¸¤ä¸ªFilterï¼Œè€Œæˆ‘ä»¬çš„demoæ˜¯JWTè®¤è¯æ–¹å¼æ‰€ä»¥ç”¨ä¸ä¸Šã€‚

å› ä¸ºSpring Securityè‡ªå¸¦çš„è¿‡æ»¤å™¨ä¸­æ˜¯æ²¡æœ‰é’ˆå¯¹JWTè¿™ç§è®¤è¯æ–¹å¼çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„demoä¸­ä¼šå†™ä¸€ä¸ªJWTçš„è®¤è¯è¿‡æ»¤å™¨ï¼Œç„¶åæ”¾åœ¨ç»¿è‰²çš„ä½ç½®è¿›è¡Œè®¤è¯å·¥ä½œã€‚

### SpringSecurityçš„é‡è¦æ¦‚å¿µ
çŸ¥é“äº†Spring Securityçš„å¤§è‡´å·¥ä½œæµç¨‹ä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦çŸ¥é“ä¸€äº›éå¸¸é‡è¦çš„æ¦‚å¿µä¹Ÿå¯ä»¥è¯´æ˜¯ç»„ä»¶ï¼š
- **SecurityContext**ï¼šä¸Šä¸‹æ–‡å¯¹è±¡ï¼ŒAuthenticationå¯¹è±¡ä¼šæ”¾åœ¨é‡Œé¢ï¼›
- **SecurityContextHolder**ï¼šç”¨äºæ‹¿åˆ°ä¸Šä¸‹æ–‡å¯¹è±¡çš„é™æ€å·¥å…·ç±»ï¼›
- **Authentication**ï¼šè®¤è¯æ¥å£ï¼Œå®šä¹‰äº†è®¤è¯å¯¹è±¡çš„æ•°æ®å½¢å¼ï¼›
- **AuthenticationManager**ï¼šç”¨äºæ ¡éªŒAuthenticationï¼Œè¿”å›ä¸€ä¸ªè®¤è¯å®Œæˆåçš„Authenticationå¯¹è±¡ã€‚

#### SecurityContext
ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œè®¤è¯åçš„æ•°æ®å°±æ”¾åœ¨è¿™é‡Œé¢ï¼Œæ¥å£å®šä¹‰å¦‚ä¸‹ï¼š
```java
public interface SecurityContext extends Serializable {
 // è·å–Authenticationå¯¹è±¡
 Authentication getAuthentication();

 // æ”¾å…¥Authenticationå¯¹è±¡
 void setAuthentication(Authentication authentication);
}
```
è¿™ä¸ªæ¥å£é‡Œé¢åªæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œå…¶ä¸»è¦ä½œç”¨å°±æ˜¯get or set Authenticationã€‚

#### SecurityContextHolder
```java
public class SecurityContextHolder {

 public static void clearContext() {
  strategy.clearContext();
 }

 public static SecurityContext getContext() {
  return strategy.getContext();
 }
    
    public static void setContext(SecurityContext context) {
  strategy.setContext(context);
 }
}
```
å¯ä»¥è¯´æ˜¯SecurityContextçš„å·¥å…·ç±»ï¼Œç”¨äºget or set or clear SecurityContextï¼Œé»˜è®¤ä¼šæŠŠæ•°æ®éƒ½å­˜å‚¨åˆ°å½“å‰çº¿ç¨‹ä¸­ã€‚

#### Authentication
```java
public interface Authentication extends Principal, Serializable {
 
 Collection<? extends GrantedAuthority> getAuthorities();
 Object getCredentials();
 Object getDetails();
 Object getPrincipal();
 boolean isAuthenticated();
 void setAuthenticated(boolean isAuthenticated) throws IllegalArgumentException;
}
```
è¿™å‡ ä¸ªæ–¹æ³•æ•ˆæœå¦‚ä¸‹ï¼š
- `getAuthorities`: è·å–ç”¨æˆ·æƒé™ï¼Œä¸€èˆ¬æƒ…å†µä¸‹è·å–åˆ°çš„æ˜¯ç”¨æˆ·çš„è§’è‰²ä¿¡æ¯ï¼›
- `getCredentials`: è·å–è¯æ˜ç”¨æˆ·è®¤è¯çš„ä¿¡æ¯ï¼Œé€šå¸¸æƒ…å†µä¸‹è·å–åˆ°çš„æ˜¯å¯†ç ç­‰ä¿¡æ¯ï¼›
- `getDetails`: è·å–ç”¨æˆ·çš„é¢å¤–ä¿¡æ¯ï¼Œï¼ˆè¿™éƒ¨åˆ†ä¿¡æ¯å¯ä»¥æ˜¯æˆ‘ä»¬çš„ç”¨æˆ·è¡¨ä¸­çš„ä¿¡æ¯ï¼‰ï¼›
- `getPrincipal`: è·å–ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼Œåœ¨æœªè®¤è¯çš„æƒ…å†µä¸‹è·å–åˆ°çš„æ˜¯ç”¨æˆ·åï¼Œåœ¨å·²è®¤è¯çš„æƒ…å†µä¸‹è·å–åˆ°çš„æ˜¯ UserDetailsï¼›
- `isAuthenticated`: è·å–å½“å‰ Authentication æ˜¯å¦å·²è®¤è¯ï¼›
- `setAuthenticated`: è®¾ç½®å½“å‰ Authentication æ˜¯å¦å·²è®¤è¯ï¼ˆtrue or falseï¼‰ã€‚

`Authentication`åªæ˜¯å®šä¹‰äº†ä¸€ç§åœ¨SpringSecurityè¿›è¡Œè®¤è¯è¿‡çš„æ•°æ®çš„æ•°æ®å½¢å¼åº”è¯¥æ˜¯æ€ä¹ˆæ ·çš„ï¼Œè¦æœ‰æƒé™ï¼Œè¦æœ‰å¯†ç ï¼Œè¦æœ‰èº«ä»½ä¿¡æ¯ï¼Œè¦æœ‰é¢å¤–ä¿¡æ¯ã€‚

#### AuthenticationManager
```java
public interface AuthenticationManager {
 // è®¤è¯æ–¹æ³•
 Authentication authenticate(Authentication authentication)
   throws AuthenticationException;
}
```
`AuthenticationManager`å®šä¹‰äº†ä¸€ä¸ªè®¤è¯æ–¹æ³•ï¼Œå®ƒå°†ä¸€ä¸ªæœªè®¤è¯çš„`Authentication`ä¼ å…¥ï¼Œè¿”å›ä¸€ä¸ªå·²è®¤è¯çš„`Authentication`ï¼Œé»˜è®¤ä½¿ç”¨çš„å®ç°ç±»ä¸ºï¼š**ProviderManager**ã€‚

æ¥ä¸‹æ¥å¤§å®¶å¯ä»¥æ„æ€ä¸€ä¸‹å¦‚ä½•å°†è¿™å››ä¸ªéƒ¨åˆ†ï¼Œä¸²è”èµ·æ¥ï¼Œæ„æˆSpring Securityè¿›è¡Œè®¤è¯çš„æµç¨‹ï¼š
1. å…ˆæ˜¯ä¸€ä¸ªè¯·æ±‚å¸¦ç€èº«ä»½ä¿¡æ¯è¿›æ¥ï¼›
2. ç»è¿‡**AuthenticationManager**çš„è®¤è¯ï¼›
3. å†é€šè¿‡**SecurityContextHolder**è·å–**SecurityContext**ï¼›
4. æœ€åå°†è®¤è¯åçš„ä¿¡æ¯æ”¾å…¥åˆ°**SecurityContext**ã€‚

### ç¼–ç å‰çš„å‡†å¤‡å·¥ä½œ
é¦–å…ˆå¯¼å…¥å¿…è¦çš„ä¾èµ–ï¼Œæ•°æ®åº“ç›¸å…³çš„ä¾èµ–å¯ä»¥è‡ªè¡Œé€‰æ‹©ä»€ä¹ˆJDBCæ¡†æ¶ï¼Œè¿™é‡Œç”¨myabtis-plus
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>

<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>

<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-validation</artifactId>
</dependency>

<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt</artifactId>
    <version>0.9.0</version>
</dependency>

<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>mybatis-plus-boot-starter</artifactId>
    <version>3.3.0</version>
</dependency>

<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
    <version>5.1.47</version>
</dependency>
```

#### å®šä¹‰åŠ å¯†å™¨Bean
```java
/**
 * å®šä¹‰åŠ å¯†å™¨Bean
 * @return
 */
@Bean
public PasswordEncoder passwordEncoder() {
    return new BCryptPasswordEncoder();
}
```
è¿™ä¸ªBeanæ˜¯ä¸å¿…å¯å°‘çš„ï¼ŒSpring Securityåœ¨è®¤è¯æ“ä½œæ—¶ä¼šä½¿ç”¨æˆ‘ä»¬å®šä¹‰çš„è¿™ä¸ªåŠ å¯†å™¨ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¼šå‡ºç°å¼‚å¸¸ã€‚

#### å®šä¹‰AuthenticationManager
```java
@Bean
public AuthenticationManager authenticationManager() throws Exception {
    return super.authenticationManager();
}

```
è¿™é‡Œå°†Spring Securityè‡ªå¸¦çš„authenticationManagerå£°æ˜æˆBeanï¼Œå£°æ˜å®ƒçš„ä½œç”¨æ˜¯ç”¨å®ƒå¸®æˆ‘ä»¬è¿›è¡Œè®¤è¯æ“ä½œï¼Œè°ƒç”¨è¿™ä¸ªBeançš„authenticateæ–¹æ³•ä¼šç”±Spring Securityè‡ªåŠ¨å¸®æˆ‘ä»¬åšè®¤è¯ã€‚

#### å®ç°UserDetailsService
```java
@Slf4j
@Service("userDetailsService")
public class CustomUserDetailsService implements UserDetailsService {
    @Autowired
    private UserInfoService userService;
    @Autowired
    private RoleInfoService roleInfoService;

    @Override
    public UserDetails loadUserByUsername(String s) throws UsernameNotFoundException {
        log.info("å¼€å§‹ç™»é™†éªŒè¯ï¼Œç”¨æˆ·åä¸º: {}", s);

        // æ ¹æ®ç”¨æˆ·åéªŒè¯ç”¨æˆ·
        QueryWrapper<UserInfo> queryWrapper = new QueryWrapper<>();
        queryWrapper.lambda().eq(UserInfo::getUsername, s);
        UserInfo userInfo = userService.getOne(queryWrapper);
        if (userInfo == null) {
            throw new UsernameNotFoundException("ç”¨æˆ·åä¸å­˜åœ¨ï¼Œç™»é™†å¤±è´¥ã€‚");
        }

        // æ„å»ºUserDetailå¯¹è±¡
        UserDetail userDetail = new UserDetail();
        userDetail.setUserInfo(userInfo);
        List<RoleInfo> roleInfoList = roleInfoService.listRoleByUserId(userInfo.getId());
        userDetail.setRoleInfoList(roleInfoList);
        return userDetail;
    }
}
```
å®ç°UserDetailsServiceçš„æŠ½è±¡æ–¹æ³•å¹¶è¿”å›ä¸€ä¸ªUserDetailså¯¹è±¡ï¼Œè®¤è¯è¿‡ç¨‹ä¸­SpringSecurityä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•è®¿é—®æ•°æ®åº“è¿›è¡Œå¯¹ç”¨æˆ·çš„æœç´¢ï¼Œé€»è¾‘ä»€ä¹ˆéƒ½å¯ä»¥è‡ªå®šä¹‰ï¼Œæ— è®ºæ˜¯ä»æ•°æ®åº“ä¸­è¿˜æ˜¯ä»ç¼“å­˜ä¸­ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦å°†æˆ‘ä»¬æŸ¥è¯¢å‡ºæ¥çš„ç”¨æˆ·ä¿¡æ¯å’Œæƒé™ä¿¡æ¯ç»„è£…æˆä¸€ä¸ªUserDetailsè¿”å›ã€‚

**UserDetails** ä¹Ÿæ˜¯ä¸€ä¸ªå®šä¹‰äº†æ•°æ®å½¢å¼çš„æ¥å£ï¼Œç”¨äºä¿å­˜æˆ‘ä»¬ä»æ•°æ®åº“ä¸­æŸ¥å‡ºæ¥çš„æ•°æ®ï¼Œå…¶åŠŸèƒ½ä¸»è¦æ˜¯éªŒè¯è´¦å·çŠ¶æ€å’Œè·å–æƒé™ã€‚

#### TokenUtil
ç”±äºæˆ‘ä»¬æ˜¯JWTçš„è®¤è¯æ¨¡å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿéœ€è¦ä¸€ä¸ªå¸®æˆ‘ä»¬æ“ä½œTokençš„å·¥å…·ç±»ï¼Œä¸€èˆ¬æ¥è¯´å®ƒå…·æœ‰ä»¥ä¸‹ä¸‰ä¸ªæ–¹æ³•å°±å¤Ÿäº†ï¼š
- åˆ›å»ºtoken
- éªŒè¯token
- åè§£ætokenä¸­çš„ä¿¡æ¯

åœ¨ä¸‹æ–‡ä»£ç é‡Œé¢ï¼ŒJwtProviderå……å½“äº†Tokenå·¥å…·ç±»çš„è§’è‰²ã€‚

### ä»£ç ä¸­çš„å…·ä½“å®ç°
ç”¨SpringSecurityåšJWTè®¤è¯éœ€è¦æˆ‘ä»¬è‡ªå·±å†™ä¸€ä¸ªè¿‡æ»¤å™¨æ¥åšJWTçš„æ ¡éªŒï¼Œç„¶åå°†è¿™ä¸ªè¿‡æ»¤å™¨æ”¾åˆ°å¼€ç¯‡é‚£å¼ å›¾çš„ç»¿è‰²éƒ¨åˆ†ã€‚

åœ¨æˆ‘ä»¬ç¼–å†™è¿™ä¸ªè¿‡æ»¤å™¨ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è¿›è¡Œä¸€ä¸ªè®¤è¯æ“ä½œï¼Œå› ä¸ºæˆ‘ä»¬è¦å…ˆè®¿é—®è®¤è¯æ¥å£æ‹¿åˆ°tokenï¼Œæ‰èƒ½æŠŠtokenæ”¾åˆ°è¯·æ±‚å¤´ä¸Šï¼Œè¿›è¡Œæ¥ä¸‹æ¥è¯·æ±‚ã€‚

#### è®¤è¯æ–¹æ³•
è®¿é—®ä¸€ä¸ªç³»ç»Ÿï¼Œä¸€èˆ¬æœ€å…ˆè®¿é—®çš„æ˜¯è®¤è¯æ–¹æ³•ï¼Œè¿™é‡Œå†™äº†æœ€ç®€ç•¥çš„è®¤è¯éœ€è¦çš„å‡ ä¸ªæ­¥éª¤ï¼Œå› ä¸ºå®é™…ç³»ç»Ÿä¸­æˆ‘ä»¬è¿˜è¦å†™ç™»å½•è®°å½•å•Šï¼Œå‰å°å¯†ç è§£å¯†å•Šè¿™äº›æ“ä½œã€‚
```java
@Service
public class AuthServiceImpl implements AuthService {

    @Autowired
    private AuthenticationManager authenticationManager;
    @Autowired
    private JwtProvider jwtProvider;

    @Override
    public Object login(String loginAccount, String password) {
        // 1 åˆ›å»ºUsernamePasswordAuthenticationToken
        UsernamePasswordAuthenticationToken usernameAuthentication = new UsernamePasswordAuthenticationToken(loginAccount, password);
        // 2 è®¤è¯
        Authentication authentication = authenticationManager.authenticate(usernameAuthentication);
        // 3 ä¿å­˜è®¤è¯ä¿¡æ¯
        SecurityContextHolder.getContext().setAuthentication(authentication);
        // 4 ç”Ÿæˆè‡ªå®šä¹‰token
        UserDetail userDetail = (UserDetail) authentication.getPrincipal();
        AccessToken accessToken = jwtProvider.createToken(userDetail);

        // 5 æ”¾å…¥ç¼“å­˜
        // ...
        return JSONUtil.parseObj(accessToken);
    }
}
```
è¿™é‡Œä¸€å…±äº”ä¸ªæ­¥éª¤ï¼š
1. ä¼ å…¥ç”¨æˆ·åå’Œå¯†ç åˆ›å»ºäº†ä¸€ä¸ª **UsernamePasswordAuthenticationToken** å¯¹è±¡ï¼Œè¿™æ˜¯æˆ‘ä»¬å‰é¢è¯´è¿‡çš„ **Authentication** çš„å®ç°ç±»ï¼Œä¼ å…¥ç”¨æˆ·åå’Œå¯†ç åšæ„é€ å‚æ•°ï¼Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯æˆ‘ä»¬åˆ›å»ºå‡ºæ¥çš„æœªè®¤è¯çš„ **Authentication** å¯¹è±¡ã€‚
2. ä½¿ç”¨æˆ‘ä»¬å…ˆå‰å·²ç»å£°æ˜è¿‡çš„Bean-**authenticationManager**è°ƒç”¨å®ƒçš„**authenticate**æ–¹æ³•è¿›è¡Œè®¤è¯ï¼Œè¿”å›ä¸€ä¸ªè®¤è¯å®Œæˆçš„**Authentication**å¯¹è±¡ã€‚
3. è®¤è¯å®Œæˆæ²¡æœ‰å‡ºç°å¼‚å¸¸ï¼Œå°±ä¼šèµ°åˆ°ç¬¬ä¸‰æ­¥ï¼Œä½¿ç”¨**SecurityContextHolder**è·å–**SecurityContext**ä¹‹åï¼Œå°†è®¤è¯å®Œæˆä¹‹åçš„**Authentication**å¯¹è±¡ï¼Œæ”¾å…¥ä¸Šä¸‹æ–‡å¯¹è±¡ã€‚
4. ä»**Authentication**å¯¹è±¡ä¸­æ‹¿åˆ°æˆ‘ä»¬çš„**UserDetails**å¯¹è±¡ï¼Œä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼Œè®¤è¯åçš„**Authentication**å¯¹è±¡è°ƒç”¨å®ƒçš„getPrincipal()æ–¹æ³•å°±å¯ä»¥æ‹¿åˆ°æˆ‘ä»¬å…ˆå‰æ•°æ®åº“æŸ¥è¯¢åç»„è£…å‡ºæ¥çš„**UserDetails**å¯¹è±¡ï¼Œç„¶ååˆ›å»º**token**ã€‚
5. æŠŠ**UserDetails**å¯¹è±¡æ”¾å…¥ç¼“å­˜ä¸­ï¼Œæ–¹ä¾¿åé¢è¿‡æ»¤å™¨ä½¿ç”¨ã€‚

è¿™æ ·çš„è¯å°±ç®—å®Œæˆäº†ï¼Œæ„Ÿè§‰ä¸Šå¾ˆç®€å•ï¼Œå› ä¸ºä¸»è¦è®¤è¯æ“ä½œéƒ½ä¼šç”±authenticationManager.authenticate()å¸®æˆ‘ä»¬å®Œæˆã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥çœ‹çœ‹æºç ï¼Œä»ä¸­çª¥å¾—Spring Securityæ˜¯å¦‚ä½•å¸®æˆ‘ä»¬åšè¿™ä¸ªè®¤è¯çš„ï¼ˆçœç•¥äº†ä¸€éƒ¨åˆ†ï¼‰ï¼š
```java
// AbstractUserDetailsAuthenticationProvider
public Authentication authenticate(Authentication authentication){
  // æ ¡éªŒæœªè®¤è¯çš„Authenticationå¯¹è±¡é‡Œé¢æœ‰æ²¡æœ‰ç”¨æˆ·å
  String username = (authentication.getPrincipal() == null) ? "NONE_PROVIDED": authentication.getName();  
    
     boolean cacheWasUsed = true;
     // ä»ç¼“å­˜ä¸­å»æŸ¥ç”¨æˆ·åä¸ºXXXçš„å¯¹è±¡
  UserDetails user = this.userCache.getUserFromCache(username);

     // å¦‚æœæ²¡æœ‰å°±è¿›å…¥åˆ°è¿™ä¸ªæ–¹æ³•
  if (user == null) {
   cacheWasUsed = false;

   try {
    // è°ƒç”¨æˆ‘ä»¬é‡å†™UserDetailsServiceçš„loadUserByUsernameæ–¹æ³•
    // æ‹¿åˆ°æˆ‘ä»¬è‡ªå·±ç»„è£…å¥½çš„UserDetailså¯¹è±¡
    user = retrieveUser(username,
      (UsernamePasswordAuthenticationToken) authentication);
   }
   catch (UsernameNotFoundException notFound) {
    logger.debug("User '" + username + "' not found");

    if (hideUserNotFoundExceptions) {
     throw new BadCredentialsException(messages.getMessage(
       "AbstractUserDetailsAuthenticationProvider.badCredentials",
       "Bad credentials"));
    }
    else {
     throw notFound;
    }
   }

   Assert.notNull(user,
     "retrieveUser returned null - a violation of the interface contract");
  }
    
    try {
         // æ ¡éªŒè´¦å·æ˜¯å¦ç¦ç”¨
   preAuthenticationChecks.check(user);
         // æ ¡éªŒæ•°æ®åº“æŸ¥å‡ºæ¥çš„å¯†ç ï¼Œå’Œæˆ‘ä»¬ä¼ å…¥çš„å¯†ç æ˜¯å¦ä¸€è‡´
   additionalAuthenticationChecks(user,
     (UsernamePasswordAuthenticationToken) authentication);
  }
}
```
å…¶ä¸»è¦é€»è¾‘ä¹Ÿæ˜¯æŸ¥æ•°æ®åº“ç„¶åå¯¹æ¯”å¯†ç ã€‚

ç™»å½•æ•ˆæœå¦‚ä¸‹ï¼š  
![png](images/ç™»å½•æ•ˆæœå›¾.png)

æˆ‘ä»¬è¿”å›tokenä¹‹åï¼Œä¸‹æ¬¡è¯·æ±‚å…¶ä»–APIçš„æ—¶å€™å°±è¦åœ¨è¯·æ±‚å¤´ä¸­å¸¦ä¸Šè¿™ä¸ªtokenï¼Œéƒ½æŒ‰ç…§JWTçš„æ ‡å‡†æ¥åšå°±å¯ä»¥ã€‚

#### JWTè¿‡æ»¤å™¨
æœ‰äº†tokenä¹‹åï¼Œæˆ‘ä»¬è¦æŠŠè¿‡æ»¤å™¨æ”¾åœ¨è¿‡æ»¤å™¨é“¾ä¸­ï¼Œç”¨äºè§£ætokenï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰sessionï¼Œæ‰€ä»¥æˆ‘ä»¬æ¯æ¬¡å»è¾¨åˆ«è¿™æ˜¯å“ªä¸ªç”¨æˆ·çš„è¯·æ±‚çš„æ—¶å€™ï¼Œéƒ½æ˜¯æ ¹æ®è¯·æ±‚ä¸­çš„tokenæ¥è§£æå‡ºæ¥å½“å‰æ˜¯å“ªä¸ªç”¨æˆ·ã€‚

æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªè¿‡æ»¤å™¨å»æ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼Œå‰æ–‡æˆ‘ä»¬ä¹Ÿè¯´è¿‡ï¼Œè¿™ä¸ªè¿‡æ»¤å™¨æˆ‘ä»¬ä¼šæ”¾åœ¨ç»¿è‰²éƒ¨åˆ†ç”¨æ¥æ›¿ä»£**UsernamePasswordAuthenticationFilter**ï¼Œæ‰€ä»¥æˆ‘ä»¬æ–°å»ºä¸€ä¸ª**JwtAuthenticationTokenFilter**ï¼Œç„¶åå°†å®ƒæ³¨å†Œä¸ºBeanï¼Œå¹¶åœ¨ç¼–å†™é…ç½®æ–‡ä»¶çš„æ—¶å€™éœ€è¦åŠ ä¸Šè¿™ä¸ªï¼š
```java
@Bean
public JwtAuthenticationTokenFilter jwtAuthenticationTokenFilter() {
    return new JwtAuthenticationTokenFilter();
}

@Override
protected void configure(HttpSecurity http) throws Exception {
    http.addFilterBefore(jwtAuthenticationTokenFilter(),UsernamePasswordAuthenticationFilter.class);
}
```
addFilterBeforeçš„è¯­ä¹‰æ˜¯æ·»åŠ ä¸€ä¸ªFilteråˆ°XXXFilterä¹‹å‰ï¼Œæ”¾åœ¨è¿™é‡Œå°±æ˜¯æŠŠ**JwtAuthenticationTokenFilter**æ”¾åœ¨**UsernamePasswordAuthenticationFilter**ä¹‹å‰ï¼Œå› ä¸ºfilterçš„æ‰§è¡Œä¹Ÿæ˜¯æœ‰é¡ºåºçš„ï¼Œæˆ‘ä»¬å¿…é¡»è¦æŠŠæˆ‘ä»¬çš„filteræ”¾åœ¨è¿‡æ»¤å™¨é“¾ä¸­ç»¿è‰²çš„éƒ¨åˆ†æ‰ä¼šèµ·åˆ°è‡ªåŠ¨è®¤è¯çš„æ•ˆæœã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥çœ‹çœ‹JwtAuthenticationTokenFilterçš„å…·ä½“å®ç°äº†ï¼š
```java
@Slf4j
public class JwtAuthenticationTokenFilter extends OncePerRequestFilter {

    @Autowired
    private JwtProvider jwtProvider;
    @Autowired
    private JwtProperties jwtProperties;

    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain chain) throws ServletException, IOException {
        log.info("JWTè¿‡æ»¤å™¨é€šè¿‡æ ¡éªŒè¯·æ±‚å¤´tokenè¿›è¡Œè‡ªåŠ¨ç™»å½•...");

        // æ‹¿åˆ°Authorizationè¯·æ±‚å¤´å†…çš„ä¿¡æ¯
        String authToken = jwtProvider.getToken(request);

        // åˆ¤æ–­ä¸€ä¸‹å†…å®¹æ˜¯å¦ä¸ºç©º
        if (StrUtil.isNotEmpty(authToken) && authToken.startsWith(jwtProperties.getTokenPrefix())) {
            // å»æ‰tokenå‰ç¼€(Bearer )ï¼Œæ‹¿åˆ°çœŸå®token
            authToken = authToken.substring(jwtProperties.getTokenPrefix().length());

            // æ‹¿åˆ°tokené‡Œé¢çš„ç™»å½•è´¦å·
            String loginAccount = jwtProvider.getSubjectFromToken(authToken);

            if (StrUtil.isNotEmpty(loginAccount) && SecurityContextHolder.getContext().getAuthentication() == null) {
                // ç¼“å­˜é‡ŒæŸ¥è¯¢ç”¨æˆ·ï¼Œä¸å­˜åœ¨éœ€è¦é‡æ–°ç™»é™†
                //UserDetail userDetails = caffeineCache.get(CacheName.USER, loginAccount, UserDetail.class);
                UserDetail userDetails = null;

                // æ‹¿åˆ°ç”¨æˆ·ä¿¡æ¯åéªŒè¯ç”¨æˆ·ä¿¡æ¯ä¸token
                if (userDetails != null && jwtProvider.validateToken(authToken, userDetails)) {

                    // ç»„è£…authenticationå¯¹è±¡ï¼Œæ„é€ å‚æ•°æ˜¯Principal Credentials ä¸ Authorities
                    // åé¢çš„æ‹¦æˆªå™¨é‡Œé¢ä¼šç”¨åˆ° grantedAuthorities æ–¹æ³•
                    UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken(userDetails, userDetails.getPassword(), userDetails.getAuthorities());

                    // å°†authenticationä¿¡æ¯æ”¾å…¥åˆ°ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­
                    SecurityContextHolder.getContext().setAuthentication(authentication);

                    log.info("JWTè¿‡æ»¤å™¨é€šè¿‡æ ¡éªŒè¯·æ±‚å¤´tokenè‡ªåŠ¨ç™»å½•æˆåŠŸ, user : {}", userDetails.getUsername());
                }
            }
        }
        chain.doFilter(request, response);
    }
}
```
1. æ‹¿åˆ°Authorizationè¯·æ±‚å¤´å¯¹åº”çš„tokenä¿¡æ¯ã€‚
2. å»æ‰tokençš„å¤´éƒ¨(Bearer )ã€‚
3. è§£ætokenï¼Œæ‹¿åˆ°æˆ‘ä»¬æ”¾åœ¨é‡Œé¢çš„ç™»é™†è´¦å·ã€‚
4. å› ä¸ºæˆ‘ä»¬ä¹‹å‰ç™»é™†è¿‡ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥ä»ç¼“å­˜é‡Œé¢æ‹¿æˆ‘ä»¬çš„UserDetailä¿¡æ¯å³å¯ã€‚
5. æŸ¥çœ‹æ˜¯å¦UserDetailä¸ºnullï¼Œä»¥åŠæŸ¥çœ‹tokenæ˜¯å¦è¿‡æœŸï¼ŒUserDetailç”¨æˆ·åä¸tokenä¸­çš„æ˜¯å¦ä¸€ç›´ã€‚
6. ç»„è£…ä¸€ä¸ªauthenticationå¯¹è±¡ï¼ŒæŠŠå®ƒæ”¾åœ¨ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­ï¼Œè¿™æ ·åé¢çš„è¿‡æ»¤å™¨çœ‹åˆ°æˆ‘ä»¬ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­æœ‰authenticationå¯¹è±¡ï¼Œå°±ç›¸å½“äºæˆ‘ä»¬å·²ç»è®¤è¯è¿‡äº†ã€‚

è¿™æ ·çš„è¯ï¼Œæ¯ä¸€ä¸ªå¸¦æœ‰æ­£ç¡®tokençš„è¯·æ±‚è¿›æ¥ä¹‹åï¼Œéƒ½ä¼šæ‰¾åˆ°å®ƒçš„è´¦å·ä¿¡æ¯ï¼Œå¹¶æ”¾åœ¨ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨SecurityContextHolderå¾ˆæ–¹ä¾¿çš„æ‹¿åˆ°ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­çš„Authenticationå¯¹è±¡ã€‚


ç»“åˆè®¤è¯æ–¹æ³•ï¼Œæˆ‘ä»¬çš„é€»è¾‘é“¾å°±å˜æˆäº†ï¼š
ç™»å½•ğŸ‘‰æ‹¿åˆ°tokenğŸ‘‰è¯·æ±‚å¸¦ä¸ŠtokenğŸ‘‰JWTè¿‡æ»¤å™¨æ‹¦æˆªğŸ‘‰æ ¡éªŒtokenğŸ‘‰å°†ä»ç¼“å­˜ä¸­æŸ¥å‡ºæ¥çš„å¯¹è±¡æ”¾åˆ°ä¸Šä¸‹æ–‡ä¸­